name: Python Testing and AWS Back-End Infrastructure Deployment
run-name: ${{ github.actor }} is testing and deploying Back-End Infrastructure update in GitHub Actions ðŸš€

on: 
  push:
    branches:
      - main
      
permissions:
  contents: read

jobs:
  test-lambda:
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@55d479fb1c5bcad5a4f9099a5d9f37c8857b2845 # v2.4.1
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            toolbox-data.anchore.io:443

      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
      - name: Set up Python
        uses: actions/setup-python@bd6b4b6205c4dbad673328db7b31b7fab9e241c0 # v4.6.1
        with:
          python-version: '3.8'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r python/requirements.txt
      - name: Create SBOM
        uses: anchore/sbom-action@4d571ad1038a9cc29d676154ef265ab8f9027042 # v0.14.2
        with:
          path: ./python/
          artifact-name: sbom.spdx
          output-file: ./sbom.spdx
      - name: Determine current dir and files
        run: |
          ls -la
          pwd
      - name: Scan SBOM
        uses: anchore/scan-action@4be3c24559b430723e51858969965e163b196957 # v3.3.5
        with:
          sbom: sbom.spdx
      - name: Run tests and linting
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --max-complexity=10 --max-line-length=127
          pytest -sv
        
  update-infra:
    runs-on: ubuntu-latest
    needs: test-lambda
    environment:
      name: production
    env:
      working_directory: ./terraform
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read  # This is required for actions/checkout
    steps: 
      - name: Harden Runner
        uses: step-security/harden-runner@55d479fb1c5bcad5a4f9099a5d9f37c8857b2845 # v2.4.1
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            apigateway.us-east-1.amazonaws.com:443
            checkpoint-api.hashicorp.com:443
            dynamodb.us-east-1.amazonaws.com:443
            gb-crc-terraform-state.s3.amazonaws.com:443
            github.com:443
            iam.amazonaws.com:443
            lambda.us-east-1.amazonaws.com:443
            registry.terraform.io:443
            releases.hashicorp.com:443
            sts.amazonaws.com:443
            sts.us-east-1.amazonaws.com:443

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@5fd3084fc36e372ff1fff382a39b10d03659f355 # master
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.WRITE_ROLE }}
          role-session-name: OIDCSession
      - name: Download repo
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
      - name: Set Python to 3.8
        uses: actions/setup-python@bd6b4b6205c4dbad673328db7b31b7fab9e241c0 # v4.6.1
        with:
          python-version: "3.8"
      - name: Terraform init and validate
        working-directory: ${{ env.working_directory }}
        run: |
           echo `pwd`
           terraform init -input=false
           terraform fmt -diff
           terraform apply -auto-approve
           
#       - name: Upload Terraform state file
#         uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # v3.1.2
#         with:
#             name: terraform.tfstate
#             path: ./terraform/terraform.tfstate
#       - name: Build SAM template for deployment 
#         run: sam build
#       - name: Deploy SAM template to AWS
#         run: sam deploy --no-confirm-changeset --no-fail-on-empty-changeset --debug
